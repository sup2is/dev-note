

# Real MySQL 8.0



# #1 소개

# #2 설치와 설정

# #3 사용자 및 권한

# #4 아키텍처

# #5 트랜잭션과 잠금

# #6 데이터 압축

- MySQL 서버에서 디스크에 저장된 데이터 파일의 크기는 일반적으로 쿼리의 처리 성능과도 직결되지만 백업 및 복구 시간과도 밀접하게 연결된다.
- 디스크 데이터 파일이 크면 클수록 비용, 속도문제, 성능문제 등으로 많은 DBMS가 이런 문제점들을 해결하기 위해 데이터 압축 기능을 제공한다.



## 페이지 압축

- MySQL 서버에서는 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고, 반대로 MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제된다.
  - 버퍼 풀에 데이터 페이지가 적재되면 InnoDB 스토리지 엔진은 압축이 해제된 상태로만 데이터 페이지를 관리한다.
  - 이때 문제가 되는게 16kb 데이터 페이지를 압축한 결과가 용량이 얼마나 될지 예측이 불가능하고 하나의 테이블은 동일한 크기의 페이지로 통일돼야 한다는 것
- 그래서 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 펀치홀이라는 기능을 사용한다.

`펀치홀 동작방식`

1. 16kb 페이지를 압축 (압축 결과를 7kb로 가정)
2. MySQL 서버는 디스크에 압축된 결과 7kb를 기록 (이때 MySQL 서버는 압축 데이터 7kb에 9kb의 빈 데이터를 기록)
3. 디스크에 데이터를 기록한 후, 7kb 이후의 공간 9kb에 대해 펀치 홀을 생성
4. 파일 시스템은 7kb만 남기고 나머지지 디스크의 9kb공간은 다시 운영체제로 반납

`펀치홀 단점`

- 펀치홀 기능은 운영체제뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 한다.
- 아직 파일 시스템 관련 명령어가 펀치홀을 지원하지 못한다.
  - ex: 펀치홀이 적용되어 1gb로 압축되었다고 하더라도 `cp` 명령어로 복사하면 펀치홀이 다시 채워져 원본 크기인 10gb가 될 수 있다.
- 이런한 이유로 실제 페이지 압축은 많이 사용되지 않는다.



`페이지 압축을 이용하기`

```sql
// 테이블 생성시
mysql> CREATE TABLE t1 (c1 INT) COMPRESSION="zlib"

// 테이블 변경시
mysql> ALTER TABLE t1 COMPRESSION="zlib"
mysql> OPTIMIZE TABLE t1;
```



## 테이블 압축

- 테이블 압축은 운영체제나 하드웨어에 대한 제약이 없기 때문에 일반적으로도 활용도가 높다.
- 하지만 아래와 같은 단점이 있다.

`테이블 압축의 단점`

- 버퍼 풀 공간 활용률이 낮다.
- 쿼리 처리 성능이 낮다.
- 빈번한 데이터 변경시 압축률이 떨어진다.



### 압축 테이블 생성

- 테이블 압축을 사용하기 위한 전제 조건으로 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다.
  - innodb_file_per_table 시스템 변수가 ON으로 설정된 상태에서 테이블이 생성돼야 한다.
- 테이블 압축을 사용하는 테이블은 테이블을 생성할 때 `ROW_FORMAT=COMPRESSED` 옵션을 명시해야 한다.
- `KEY_BLOCK_SIZE`(2n, n 값은 2 이상)을 이용해 압축된 페이지의 타깃 크기를 명시한다.
  - InnoDB 스토리지엔진의 페이지크기가 16kb라면 4kb 또는 8kb만 설정이 가능하다.
- 페이지크기가 32kb 또는 64kb인 경우에는 테이블 압축을 적용할 수 없다.

```sql
mysql> SET GLOBAL innodb_file_per_table=ON;

-- // ROW_FORMAT 옵션과 KEY_BLOCK_SIZE 옵션을 모두 명시
mysql> CREATE TABLE compressed_table (
  c1 INT PRIMARY KEY
)
ROW_FORMAT=COMPRESSED
KEY_BLOCK_SIZE=8;

-- //KEY_BLOCK_SIZE 옵션만 명시
mysql> CREATE TABLE compressed_table (
  c1 INT PRIMARY KEY
)
KEY_BLOCK_SIZE=8;

-- //위와 같은 경우에는 자동으로 ROW_FORMAT=COMPRESSED 옵션이 추가되어 생성된다.
-- //KEY_BLOCK_SIZE의 옵션값은 kb

```



`InnoDB 스토리지 엔진이 압축을 적용하는 방법`

- InnoDB 스토리지 엔진의 데이터 페이지 크기가 16kb, `KEY_BLOCK_SIZE`= 8 이라고 가정

- 16kb의 데이터 페이지를 압축
  - 압축된 결과가 8kb 이하이면 그대로 디스크에 저장 (압축 완료)
  - 압축된 결과가 8kb를 초과하면 원본 페이지를 스플릿해서 2개의 페이지에 8kb씩 저장
- 나뉜 페이지 각각에 대해 1번 단계를 반복 실행  

- 테이블 압축 방식에서 가장 중요한 것은 원본 데이터 페이지의 압축 결과가 목표크기(`KEY_BLOCK_SIZE`) 보다 작거나 같을 때까지 반복해서 페이지를 스플릿하는 것이다.
- 목표 크기가 잘못 설정되면 MySQL 서버의 처리 성능이 급격히 떨어질 수 있음을 주의!



### KEY_BLOCK_SIZE 결정

- `KEY_BLOCK_SIZE` 가 테이블 압축에서 가장 중요하기 때문에 4kb, 8kb로 테이블을 생성해서 샘플데이터를 저장해보고 적절한지 판단하는 것이 좋다.
  - 최소한 테이블의 데이터 페이지가 10개 정도는 되어야 유의미한 테스트가 된다.





