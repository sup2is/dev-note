# 데이터 중심 애플리케이션 설계



# #1 신뢰할 수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션

- 오늘날 많은 애플리케이션은 계산 중심과는 다르게 데이터 중심 적이다. 이는 CPU 성능이 아닌 데이터의 양, 데이터의 복잡도, 데이터의 변화 속도가 더 중요하다.

## 데이터 시스템에 대한 생각

- 이 책에서는 대부분의 소프트웨어 시스템에서 중요하게 여기는 세가지 관심사에 중점을 둔다.

`신뢰성 Reliability`

- 하드웨어나 소프트웨어 겨함. 심지어 인적 오류 같은 역경에 직면하더라도 시스템은 지속적으로 올바르게 동작해야 한다.

`확장성 Scalability`

- 시스템의 데이터 양, 트래픽 양, 복잡도가 증가하면서 이를 처리할 수 있는 적절한 방법이 있어야 한다.

`유지보수성 Maintainability`

- 시간이 지남에 따라 여러 다양한 사람들이 시스템 상에서 작업할 것이기 때문에 모든 사용자가 시스템 상에서 생산적으로 작업할 수 있게 해야 한다.



## 신뢰성

- 소프트웨어에서 기대하는 일반적인 기대치
  - 애플리케이션은 사용자가 기대한 기능을 수행한다.
  - 시스템은 사용자가 범한 실수나 예상치 못한 소프트웨어 사용법을 허용할 수 있다.
  - 시스템 성능은 예상된 부하와 데이터 양에서 필수적인 사용 사례를 충분히 만족한다.
  - 시스템은 허가되지 않은 접근과 오남용을 방지한다.
- 잘못될 수 있는 일을 결함 이라고 부르고 그 결함을 예측하고 대처할 수 있는 시스템을 내결함성 또는 탄력성을 지녔다고 말한다.
- 결함이 0일수는 없다. 하지만 특정 결함으로 인해 장애가 발생하지 않게끔 내결함성 구조를 설계하는 것이 좋다.



### 하드웨어 결함

### 소프트웨어 오류

### 인적 오류

- 사람이 미덥지 않음에도 시스템을 어떻게 신뢰성 있게 만들까에 대한 아이디어들
  - 오류의 가능성을 최소화하는 방향으로 시스템을 설계하라. 잘 설계된 추상화, API, 관리 인터페이스를 사용하면 옳은 일은 쉽게하고 잘못된 일은 막을 수 있다. 인터페이스가 지나치게 제한적이면 사람들은 좋은 점을 잊은 채 제한된 인터페이스를 피해 작업한다. 이런 시스템 설계는 올바르게 작동하게끔 균형을 맞추기가 어렵다.
  - 사람이 가장 많이 실수하는 장소에서 사람의 실수로 장애가 발생할 수 있는 부분을 분리하라. 비 프로덕션 샌드박스를 제공하라.
  - 단위 테스트부터 전체 시스템 통합 테스트와 수동 테스트까지 모든 수준에서 철저하게 테스트하라.
  - 장애 발생의 영향을 최소화하기 위해 인적 오류를 빠르고 쉽게 복수할 수 있게 하라. 예를 들어 설정 변경 내역을 rollback하고 새로운 코드를 서서히 rollout 하게 만들기
  - 성능 지표와 오류율 같은 상세하고 명확한 모니터링 대책을 마련하라.
  - 조작 교육과 실습을 시행하라.



### 신뢰성은 얼마나 중요할까?

- 비즈니스 애플리케이션에서 버그는 생산성 저하의 원인이고 전자 상거래 사이트의 중단은 많은 비용을 초래한다.
- 모든 애플리케이션은 안정적으로 작동해야 한다.



## 확장성

- 시스템이 현재 안정적으로 동작한다고 해서 미래에도 안정적으로 동작한다는 보장은 없다.
- 성능 저하를 유발하는 흔한 이유중 하나는 부하 증가다.
- 확장성을 논한다는 것은 아래와 같은 질문을 고려한다는 의미다.
  - 시스템이 특정 방식으로 커지면 이에 대처하기 위한 선택은 무엇인가?
  - 추가 부하를 다루기 위해 계산 자원을 어떻게 투입할까?

### 부하 기술하기

- 무엇보다 시스템의 현재 부하를 간결하게 기술해야 한다. 그래야 부하 성장 질문을 논의할 수 있다.

### 성능 기술하기

- 일단 시스템 부하를 기술하면 부하가 증가할 때 어떤 일이 일어나는지 조사할 수 있다.
  - 부하 매개변수를 증가시키고 시스템 자원은 변경하지 않고 유지하면 시스템 성능은 어떻게 영향을 받을까?
  - 부하 매개변수를 증가시켰을 때 변하지 않고 유지되길 원한다면 자원을 얼마나 많이 늘려야 할까?



### 부하 대응 접근 방식

- 다수의 장비에 부하를 분산하는 아키텍처를 비공유(shared-nothing) 아키텍처 라고 부른다.



## 유지보수성

- 소프트웨어 비용의 대부분은 초기 개발이 아니라 지속해서 이어지는 유지보수에 들어간다는 사실은 잘 알려져 있다.
- 주의를 기울여야 할 소프트웨어 시스템 설계 원칙

`운용성`

- 운영팀이 시슽메을 원활하게 운영할 수 있게 쉽게 만들어라

`단순성`

- 시스템에서 복잡도를 최대한 제거해 새로운 엔지니어가 시스템을 이해하기 쉽게 만들어라

`발전성`

- 엔지니어가 이후에 시스템을 쉽게 변경할 수 있게 하라. 그래야 요구사항 변경 같은 예기치 않은 사용 하례를 적용하기가 쉽다.



#### 운용성: 운영의 편리함 만들기

- "좋은 운영은 나쁜 소프트웨어의 제약을 피하는 대안이 될 수 있다. 하지만 좋은 소프트웨어라도 나쁘게 운영할 경우 작동을 신뢰할 수 없다."
- 운영 중 일부 측면은 자동화할 수 있고 또 자동화 해야 한다.
- 좋은 운영팀의 역할
  - 시스템 상태를 모니터링하고 상태가 좋지 않다면 빠르게 서비스를 복원
  - 시스템 장애, 성능 저하 등의 문제의 원인을 추적
  - 보안 패치를 포함해 소프트웨어와 플랫폼을 최신 상태로 유지
  - 다른 시스템이 서로 어떻게 영향을 주는지 확인해 문제가 생길 수 있는 변경 사항을 손상을 입히기 전에 차단
  - 미래애 발생 가능한 문제를 예측해 문제가 발생하기 전에 해결
  - 배포, 설정 관리 등을 위한 모범 사례와 도구를 마련
  - 애플리케이션을 특정 플랫폼에서 다른 플랫폼으로이동하는 등 복잡한 유지보수 태스크 수행
  - 설정 변경으로 생기는 시스템 보안 유지보수
  - 예측 가능한 운영과 안정적인 서비스 환경을 유지하기 위한 절차 정의
  - 개인 인사 이동에도 시스템에 대한 조직의 지신을 보존함
- 좋은 운영성이랑 동일하게 반복되는 태스크를 쉽게 수행하게끔 만들어 운영팀이 고부가가치 활동에 노력을 집중한다는 의미다.
- 동일 반복 태스크를 쉽게하기 위한 일
  - 좋은 모니터링으로 런타임 동작과 시스템의 내부에 대한 가시성 제공
  - 표준 도구를 이용해 자동화와 통합을 위한 우수한 지원을 제공
  - 개별 장비 의존성을 회피. 유지보수를 위해 장비를 내리더라도 시스템 전체에 영향을 주지 않고 계속해서 운영 가능해야 함.
  - 좋은 문서와 이해하기 쉬운 운영 모델들 제공
  - 만족할만한 기본 동작을 제공하고 필요할 때 기본 값을 다시 정의할 수 있는 자유를 관리자에게 부여
  - 적절하게 자기 회복이 가능할 뿐 아니라 필요에 따라 관리자가 시스템 상태를 수동으로 제어할 수 있게 함
  - 예측 가능하게 동작하고 예기치 않은 상황을 최소화함

### 단순성: 복잡도 관리

- 복잡도가 높아지면 유지보수 비용이 증가한다.
- 단순성은 시스템의 핵심 목표여야 한다.
- 우발적 복잡도를 제거하기 위한 최상의 도구는 추상화다. 좋은 추상화는 깔끔하고 직관적인 외관 아래로 많은 세부 구현을 숨길 수 있다.



### 발전성: 변화를 쉽게 만들기

- 시스템의 요구사항은 끊임없이 할 가능성이 훨씬 크다.
- 데이터 시스템 변경을 쉽게 하고 변화된 요구사항에 시스템을 맞추는 방법은 시스템의 간단함과 추상화와 밀접한 관련이 있다.



## 정리

- 애플리케이션이 유용하려면 다양한 요구사항을 충족시켜야 한다.
- 다양한 요구사항에는 기능적 요구사항(실제로 동작하는 기능), 비기능적 요구사항(신뢰성, 확장성, 유지보수성) 이 있다.
- 신뢰성은 결함이 발생해도 시스템이 올바르게 동작하게 만든다는 의미다. 결함은 하드웨어, 소프트웨어, 사람에게 있을 수 있고 내결함성 기술은 최종 사용자에게 특정 유형의 결함을 숨길 수 있게 해준다.
- 확장성은 부하가 증가해도 좋은 성능을 유지하기 위한 전략을 의미한다. 확장성을 설명하려면 먼저 양적으로 부하와 성능을 설명하는 방법이 필요하다. 확장 가능한 시스템에서는 부하가 높은 상태에서 신뢰성을 유지하기 위해 처리 용량을 추가할 수 있다.
- 유지보수성에는 많은 측면이 있지만 유지보수성의 본질은 시스템에서 작업하는 엔지니어와 운영 팀의 삶을 개선하는 데 있다. 좋은 추상화는 복잡도를 줄이고 쉽게 시스템을 변경할 수 있게 하며 새로운 사용 사례에 적용하는데 도움이 된다. 좋은 운용성이란 시스템의 건강 상태를 잘 관찰할 수 있고 시스템을 효율적으로 관리하는 방법을 보유한다는 의미다.





# #2 데이터 모델과 질의 언어

- 각 계층은 명확한 데이터 모델을 제공해 하위 계층의 복잡성을 숨긴다.
- 데이터 모델은 그 위에서 소프트웨어가 할 수 있는 일과 할 수 없는 일에 지대한 영향을 주므로 애플리케이션에서 적합한 데이터 모델을 선택하는 작업은 상당히 중요하다.

## 관계형 모델과 문서 모델

- 오늘날 가장 잘 알려진 데이터 모델
- 데이터는 관계로 구성되고 각 관계는 순서 없는 튜플(row) 모음이다.



### NoSQL의 탄생

- NoSQL은 비관계형 데이터베이스 밋업용 인기 트위터 해시태그였지만 시간이 지나면서 Not Only SQL로 재해석 됐다.
- NoSQL의 다양한 원동력
  - 대규모 데이터셋이나 매우 높은 쓰기 처리량 달성을 관계형 데이터베이스보다 쉽게할 수 있는 뛰어난 확장성의 필요
  - 상용 데이터베이스 제품보다 무료 오픈소스 소프트웨어에 대한 선호도 확산
  - 관계형 모델에서 지원하지 않는 특수 질의 동작
  - 관계형 스키마의 제한에 대한 불만과 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람
- 관계형, 비관계형 데이터베이스를 함께사용하는 개념을 다중 저장소 지속성(polyglot persistence) 이라 한다.



### 객체 관계형 불일치

- 데이터를 관계형 테이블에 저장하려면 애플리케이션 코드와 데이터 베이스 모델 객체 사이에 거추장스로운 전환 계층이 필요하다. 임피던스 불일치(impedance mismatch)
- 액티브레코드나 하이버네이트 같은 ORM 프레임워크는 전환 계층에 필요한 상용구 코드의 양을 줄이지만 두 모델 간의 차이를 완벽히 숨길 수는 없다.
- 이력서같은 데이터 구조는 모든 내용을 갖추고 있는 문서라서 JSON 표현에 매우 적합하다.
- 관계형 데이터베이스의 다중 테이블 스키마보다 JSON 표현이 더 나은 지역성을 갖는다.



### 다대일과 다대다 관계

- ID를 사용하는 장점으로 ID 자체는 아무런 의미가 없기 때문에 변경할 필요가 없다.
- 중복된 데이터를 정규화하려면 다대일 관계가 필요한데 다대일 관계는 문서 모델에 적합하지 않다.
- 문서 데이터베이스는 조인에 대한 지원이 보통 약하다.



### 문서 데이터베이스는 역사를 반복하고 있나?

#### 네트워크 모델

#### 관계형 모델

#### 문서 데이터베이스와의 비교

### 관계형 데이터베이스와 오늘날의 문서 데이터베이스

- 관계형 데이터베이스와 문서 데이터베이스의를 비교하는 경우 내결함성과 동시성 처리를 포함해 고려해야 할 차이점이 많이 있다.
- **문서 데이터 모델을 선호하는 주요 이유는 스키마 유연성, 지역성에 기인한 더 나은 성능이다**
- **관계형 모델은 조인, 다대일, 다대다 관계를 더 잘 지원함으로써 문서 데이터 모델에 대항한다.**

#### 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까?

- 애플리케이션에서 데이터가 문서와 비슷한 구조라면 문서 모델을 사용하는 것이 좋다 (일대다 관계 트리로 보통 한 번에 전체 트리를 적재)
- 문서 모델은 중첩 항목을 바로 참조할 수 없어서 계층별로 탐색해야 하지만 문서가 너무 깊게 중첩되지 않으면 일반적으로 문제가 되지는 않는다.
- 애플리케이션에서 다대다 관계를 사용한다면 문서 모델은 매력이 떨어지게 된다.
- 일반적으로 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 만드는지 말할 수 없다. 데이터 항목 간에 존재하는 관계 유형에 따라 다르다.
- 상호 연결이 많은 데이터의 경우 문서 모델은 곤란하고 관계형 모델은 무난하다.

#### 문서 모델에서의 스키마 유연성

- 대부분의 문서 데이터베이스와 관계형 데이터베이스에서 지원하는 JSON은 문서의 데이터에 어떤 스키마를 강요하지는 않는다.
- 스키마가 없다는 뜻은 임의 키와 값을 문서에 추가할 수 있고 읽을 때 클라이언트는 문서에 포함된 필드의 존재 여부를 보장하지 않는다는 의미다.
- 스키마리스 방식은 컬렉션 안의 항목이 어떤 이유로 모두 동일한 구조가 아닐 때 유리하다
- 이런 경우 스키마는 득보다 실이 많다.
  - 다른 여러 유형의 오브젝트가 있고 각 유형의 오브젝트별로 자체 테이블에 넣는 방법은 실용적이지 않다.
  - 사용자가 제어할 수 없고 언제나 변경 가능한 외부 시스템에 의해 데이터 구조가 결정된다.

#### 질의를 위한 데이터 지역성

- 한번에 많은 문서에 접근해야 할때 저장소 지역성을 활용하면 성능 이점이 있다.
- 지역성의 이점은 한 번에 해당 문서의 많은 부분을 필요로 하는 경우에만 적용된다.
- 데이터베이스는 문서의 작은 부분만 접근해도 전체 문서를 적재해야 하기 때문에 큰 문서는 낭비일 수 있고 이러한 이유로 일반적으로 문서의 크기를 아주 작게 유지하라고 권장한다.
- 지역성을 위해 데이터를 함꼐 그룹화하는 개념은 문서 모델에만 국한되지 않는다. 구글의 스패너 데이터베이스, 오라클의 다중 테이블 색인 클러스터 테이블, 빅테이블 데이터 모델의 칼럼 패밀리 개념(카산드라 Hbase)이 지역성 관리와 유사한 목적이 있다.







## 데이터를 위한 질의 언어

### 웹에서의 선언형 질의

### 맵리듀스 질의

## 그래프형 데이터 모델

### 속성 그래프

### 사이퍼 질의 언어

### SQL의 그래프 질의

### 트리플 저장소와 스파클

### 초석: 데이터 로그

## 정리



